# [T1071] Small_TCP_Payload_Beacon_Detection_Splunk_Query

### Mitre Tactic:  
*Command and Control*

---

#### Description:  
Detects frequent, small-size TCP communications (≤150 bytes) that may indicate beaconing or “heartbeat” traffic used by adversaries for C2 channels. Aggregates counts by source–destination pairs and flags flows exceeding a threshold of 20 events.

---

```bash
index=network Protocol="tcp" PayloadSize<=150
| stats count by src, dest
| where count > 20
| sort -count
| table src, dest, count
```

```bash
index=zeek sourcetype="zeek:conn"
| bin _time span=10m
| stats count avg(duration) max(duration) by _time, id.orig_h, id.resp_h
| where count > 100 OR max(duration) > 600
| sort - count
| table _time, id.orig_h, id.resp_h, count, avg(duration), max(duration)
```

```bash
index=zeek sourcetype="zeek:http" 
| search user_agent="*curl/*" OR user_agent="*python-requests*" OR user_agent="*powershell*" OR user_agent="*Go-http-client*" OR user_agent="*wget*" OR user_agent="*nmap*" OR user_agent="*sqlmap*" OR user_agent="*fuzz*" OR user_agent="*bot*"
| stats count by user_agent, id.orig_h, id.resp_h, uri
| sort - count
| table user_agent, id.orig_h, id.resp_h, uri, count
```

```bash
index=zeek sourcetype="zeek:conn" id_resp_p=443 proto="tcp" service="-"
| stats count by id.orig_h, id.resp_h, id_resp_p, proto
| table id.orig_h, id.resp_h, id_resp_p, proto, count
```
