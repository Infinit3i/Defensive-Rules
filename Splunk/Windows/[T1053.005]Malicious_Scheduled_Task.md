# [T1053.005] Malicious_Scheduled_Task_Creation_Splunk_Query

### Mitre Tactic:  
*Persistence*

---

#### Description:  
Detects creation of scheduled tasks by monitoring Windows Security event 4698 for new task registrations. Extracts task name, XML content and the account that created the task to surface potential malicious persistence mechanisms.

---

```bash
index=wineventlog source="WinEventLog:Security" EventCode=4698
| table _time, host, TaskName, TaskContent, SubjectUserName, Account_Name
```

---

#### Description:  
Detects creation of scheduled tasks with additional filters to reduce noise: excludes Microsoft-managed tasks and SYSTEM account creations, extracts the action program and arguments from the task XML, and surfaces only those invoking common scripting hosts or encoded commands.

---

```bash
index=wineventlog source="WinEventLog:Security" EventCode=4698
| where SubjectUserName!="SYSTEM" AND SubjectUserName!="NT AUTHORITY\\SYSTEM"
| where NOT TaskName LIKE "\\Microsoft\\%"
| spath input=TaskContent path=Task.Actions.Execute.Program output=ActionProgram
| spath input=TaskContent path=Task.Actions.Execute.Arguments output=ActionArgs
| search ActionProgram="*\\powershell.exe" OR ActionProgram="*\\cmd.exe" OR ActionArgs="*-EncodedCommand*" OR ActionProgram="*\\wscript.exe" OR ActionProgram="*\\cscript.exe"
| table _time, host, SubjectUserName, TaskName, ActionProgram, ActionArgs
| sort _time desc
