# [T1021.002] Remote Command Exec

### Mitre Tactic:  
*Lateral Movement*

#### Description:  
Detects potential remote command execution using tools and methods such as `PsExec`, `winrs`, `wmic /node:`, or `wmiexec`. These techniques are often employed by attackers during lateral movement to execute commands on remote systems. The detection uses both Windows Event Logs (Event ID 4688) and Sysmon (Event ID 1) for coverage across different logging configurations.

```bash
index=* (EventCode=4688 OR EventCode=1) ("psexec" OR "winrs" OR "wmic /node:" OR "wmiexec")
| table _time, host, user, CommandLine, Image, ParentProcessName
```

# [T1021.002] Remote Services: SMB/Named Pipes

### Mitre Tactic:

*Lateral Movement*

#### Description:

Detects the use of **RemCom**, a remote administration tool often abused by adversaries for lateral movement. This detection relies on Sysmon Event IDs 17 and 18 (Pipe Created/Connected) and flags named pipes containing "RemCom," which is a known IoC of malicious remote service execution.

```bash
index=* source="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" (EventID=17 OR EventID=18)
PipeName="*RemCom*"
```

# [T1021.002] Smbexec Batch Execution

### Mitre Tactic:  
*Execution*

#### Description:  
Detects use of `%COMSPEC%` or `cmd.exe /Q /c` to echo commands into `C:\Windows\TEMP\execute.bat`, then execute and delete it. This pattern is typical of `smbexec.py` when sending one-off commands rather than starting an interactive shell.

```bash
index=* source=wineventlog  EventCode=4688
| where CommandLine LIKE "%C:\\Windows\\TEMP\\execute.bat%"
| table _time, host, SubjectUserName, Image, CommandLine, ParentImage
| sort _time desc
```

# [T1021.002] Smbexec Conhost Execution

### Mitre Tactic:  
*Execution*

#### Description:  
Detects `conhost.exe` launched with `0xffffffff -ForceV1`, commonly used by `smbexec.py` when spawning a console session tied to command execution. This follows `cmd.exe` running the temporary batch file.

```bash
index=* source=wineventlog  EventCode=4688
| where Image="*\\conhost.exe" AND CommandLine LIKE "%0xffffffff%" AND CommandLine LIKE "%ForceV1%"
| table _time, host, SubjectUserName, Image, CommandLine, ParentImage
| sort _time desc
```

# [T1021.002] Smbexec Logon Events

### Mitre Tactic:  
*Lateral Movement*

#### Description:  
Detects authentication and logon artifacts generated by Impacket's `smbexec.py`. This includes credential validation (4776), admin-level privileges (4672), and interactive network logons (4624). These appear in multiple rounds if an interactive shell is opened.

```bash
index=* source=wineventlog  EventCode IN (4776, 4672, 4624) LogonType=3
| table _time, host, EventCode, SubjectUserName, TargetUserName, LogonType, AuthenticationPackageName
| sort _time desc
```

# [T1021.001] Firewall RDP Rule

### Mitre Tactic:  
*Lateral Movement*

#### Description:  
Detects the creation or modification of firewall rules that allow Remote Desktop Protocol (RDP) traffic. This may indicate preparation for lateral movement or unauthorized remote access. Detection is based on Windows Security Event ID 4946, which logs inbound firewall rule changes.

```bash
index=* source=wineventlog  EventCode=4946 ("3389" OR "Remote Desktop")
| table _time, host, user, EventCode, Message
```

# [T1021.001] Remote Services: PuTTY Plink Execution

### Mitre Tactic:

*Lateral Movement*

#### Description:

Detects execution of `plink.exe`, a command-line utility used by PuTTY for SSH tunneling and remote access. Attackers commonly abuse `plink.exe` for lateral movement or to maintain covert access to compromised systems. This rule leverages Windows Security Event ID 4688, which records process creations.

```bash
index=* source=wineventlog  EventCode=4688 ProcessName="plink.exe"
```

# [T1021.002] Smbexec Service Install

### Mitre Tactic:  
*Execution*

#### Description:  
Detects creation of Windows services with random 8-character names or the string "BTOBTO", associated with Impacket's `smbexec.py`. It uses Windows Event ID 7045 for monitoring service installations. The service references a batch file `execute.bat`.

```bash
index=* source=wineventlog EventCode=7045
| where ServiceName="BTOBTO" OR ServiceFileName LIKE "%execute.bat%"
| table _time, host, EventCode, ServiceName, ServiceFileName, Message
| sort _time desc
```

---

# [T1021.002] Remote Services: SMB/Named Pipes

### Mitre Tactic:

*Lateral Movement*

#### Description:

Detects the use of **RemCom**, a remote administration tool often abused by adversaries for lateral movement. This detection relies on Sysmon Event IDs 17 and 18 (Pipe Created/Connected) and flags named pipes containing "RemCom," which is a known IoC of malicious remote service execution.

```bash
index=* source="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" (EventID=17 OR EventID=18)
PipeName="*RemCom*"
```
