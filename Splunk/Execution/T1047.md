# [T1047] WMI Persistence

### Mitre Tactic:  
*Persistence*

---

#### Description:  
Detects suspicious process executions and network connections spawned via WMI (wmiprvse.exe), a common technique for establishing persistence or performing remote execution through Windows Management Instrumentation. Monitors for Sysmon Event ID 1 (Process Creation) and Event ID 3 (Network Connection) where the parent process is `wmiprvse.exe` and the child is a high-risk interpreter or scripting host.

---

```bash
index=sysmon (EventCode=1 OR EventCode=3)
| where (ParentImage LIKE "%wmiprvse.exe%" AND (
    Image LIKE "%powershell.exe%" OR
    Image LIKE "%cmd.exe%" OR
    Image LIKE "%mshta.exe%" OR
    Image LIKE "%wscript.exe%" OR
    Image LIKE "%cscript.exe%"
  ))
| table _time, EventCode, Image, ParentImage, CommandLine, ProcessId, ParentProcessId, DestinationIp, DestinationPort, Protocol, ComputerName
| sort _time desc
```

# [T1047] Wmiexec Conhost Spawn

### Mitre Tactic:  
*Execution*

#### Description:  
Detects `cmd.exe` spawning `conhost.exe` with `0xffffffff -ForceV1`, a common behavior of Impacketâ€™s `wmiexec.py` after issuing commands through WMI.

```bash
index=wineventlog EventCode=4688
| where Image="*\\conhost.exe" AND CommandLine LIKE "%0xffffffff%" AND CommandLine LIKE "%ForceV1%"
| table _time, host, SubjectUserName, Image, CommandLine, ParentImage
| sort _time desc
```

# [T1047] Wmiexec Epoch-Based Batch

### Mitre Tactic:  
*Execution*

#### Description:  
Detects usage of `wmiexec.py` based on command output redirection to the admin share with a path using UNIX Epoch time. Logged as `wmiprvse.exe -> cmd.exe /Q /C > \\127.0.0.1\ADMIN$\__ssssssss.sssssss`.

```bash
index=wineventlog EventCode=4688
| where Image="*\\cmd.exe" AND CommandLine LIKE "%127.0.0.1\\ADMIN$\\__%"
| table _time, host, SubjectUserName, Image, CommandLine, ParentImage
| sort _time desc
```

# [T1047] Wmiexec Logon Events

### Mitre Tactic:  
*Execution*

#### Description:  
Detects authentication and interactive logon activity triggered by `wmiexec.py`. These include credential validation (4776), privilege use (4672), and network-based logon (4624) in multiple rounds.

```bash
index=wineventlog EventCode IN (4776, 4672, 4624) LogonType=3
| table _time, host, EventCode, SubjectUserName, TargetUserName, AuthenticationPackageName, LogonType
| sort _time desc
```

# [T1047] Wmiexec WMI Operational Events

### Mitre Tactic:  
*Execution*

#### Description:  
Detects evidence of WMI command execution via `wmiexec.py` in the Microsoft-Windows-WMI-Activity/Operational log. Relevant Event IDs include 5857 and 5858.

```bash
index=wineventlog source="Microsoft-Windows-WMI-Activity/Operational" EventCode IN (5857, 5858)
| table _time, host, EventCode, Message
| sort _time desc
```

# [T1047] wmiexec

### Mitre Tactic:  
*Persistence*

---

#### Description:  
Detects invocation of `wmiexec` via process creation or command-line events in Windows Event Logs, indicating potential WMI-based remote execution or persistence abuse.

---

```bash
index=wineventlog (EventCode=4688 OR EventCode=1) (CommandLine="*wmiexec*")
| table _time, host, user, CommandLine, ParentProcessName
```
